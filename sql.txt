CREATE DATABASE ticket_system CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE ticket_system;


CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(64) NOT NULL, -- SHA256 хэш
    role ENUM('распределитель', 'начальник', 'работник') NOT NULL,
    department VARCHAR(100) NOT NULL
);

CREATE TABLE tickets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    sender_email VARCHAR(100),
    tracker VARCHAR(50),
    status VARCHAR(50),
    project VARCHAR(100),
    assigned_to VARCHAR(100),
    observer VARCHAR(100),
    priority VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE ticket_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT NOT NULL,
    editor_name VARCHAR(100) NOT NULL,
    field_changed VARCHAR(50),
    old_value TEXT,
    new_value TEXT,
    comment TEXT,
    changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE
);

CREATE TABLE ticket_comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT NOT NULL,
    author VARCHAR(100),
    content TEXT NOT NULL,
    posted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE CASCADE
);

SHOW TABLES;


INSERT INTO users (
    first_name,
    last_name,
    email,
    password,
    role,
    department
) VALUES (
    'Тагир',
    'Абдуллин',
    'tagir.abdullin13@mail.ru',
    'toor',
    'начальник',
    'ИТ-отдел'
);

SELECT id, first_name, role FROM users WHERE email = :email AND password = :password;

select * from users;